package com.isi.car.models;

import java.util.ArrayList;

import com.isi.car.interfaces.ICarListener;
import com.isi.car.interfaces.ICarModel;

public class Car implements ICarModel, Runnable
{	
	// Static constants

	public static final double MINIMUM_CAPACITY = 35;
	public static final double MAXIMUM_CAPACITY = 95;
	public static final double DRIVING_DELTA = -2.3d;
	public static final double FILLING_DELTA = 3.6d;


	// Instance variables

	private double gasLevel;
	private double gasCapacity;
	private GasLevelState gasLevelState;
	private CarState carState;
	
	private ArrayList<ICarListener> listenersList;

	
	// Getter methods
	// Implementation of ICarModel interface

	@Override
	public double getGasLevel() { return this.gasLevel; }					// TODO
	@Override
	public double getGasCapacity() { return this.gasCapacity; }				// TODO
	@Override
	public GasLevelState getGasLevelState() { return this.gasLevelState; }	// TODO
	@Override
	public CarState getCarState() {  return this.carState; }				// TODO


	// Constructor

	public Car(double gasCapacity)
	{
		this.gasCapacity=gasCapacity;
	}


	// Public methods for adding/removing listeners
	
	public void addCarListener(ICarListener listener)
	{
		listenersList.add(listener);
	}

	public void removeCarListener(ICarListener listener)
	{
		 listenersList.remove(listener);
	}

	
	// Private setter methods for gas level and car state

	private synchronized void setGasLevel(double gasLevel)
	{
		if(gasLevel<=0)
		{
			this.gasLevel=0;
			this.gasLevelState=GasLevelState.Empty;
			
		}
		else if (gasLevel>=gasCapacity) 
		{
			this.gasLevel=gasCapacity;
			this.gasLevelState=GasLevelState.Full;
		}
		else
		{
			this.gasLevel=gasLevel;
			this.gasLevelState=GasLevelState.Partial;
		}
		
	}

	private synchronized void setCarState(CarState carState)
	{
		if (this.carState==carState) 
			this.carState=carState;
		for (ICarListener listener :listenersList)
			listener.updateCarState(carState);
		if (this.carState!=carState)
			new Thread(() -> run()).start();
	}
	
	
	// User action methods
	// Implementation of ICarModel interface

	@Override
	public void startDriving()
	{
		carState=CarState.Driving;
	}

	@Override
	public void stopDriving()
	{
		carState=CarState.Stopped;
	}

	@Override
	public void startFillingGas()
	{
		carState=CarState.Filling;
	}

	@Override
	public void stopFillingGas()
	{
		carState=CarState.Stopped;
	}


	// Thread method
	// Implementation of Runnable interface
	
	@Override
	public void run()
	{
		while(this.carState==CarState.Driving||this.carState==CarState.Filling)
		{
			if(this.carState==CarState.Driving)
			{
				setGasLevel(0);
			}
			else if (this.carState==CarState.Filling) 
			{
				setGasLevel(this.gasCapacity);
			}
			else
			{
				try
				{
					Thread.sleep(50);
				}
				catch (InterruptedException e) {}
			}
		}
	}
}
